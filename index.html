<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>뮤직비디오 플레이어 (JSON 순차 재생)</title>
  <style>
    :root { --pink:#f472b6; --pink-50:#fdf2f8; --pink-100:#fce7f3; --gray:#334155; --line:#e5e7eb; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Apple SD Gothic Neo,Pretendard,system-ui,sans-serif; color:var(--gray); background:var(--pink-50); }
    .wrap{ max-width:420px; margin:0 auto; min-height:100vh; display:flex; flex-direction:column; }
    header{ position:sticky; top:0; z-index:10; backdrop-filter: blur(6px); background:rgba(252, 231, 243, .9); border-bottom:1px solid var(--line); padding:12px 16px; display:flex; align-items:center; justify-content:space-between; }
    header .title{ font-weight:800; }
    main{ flex:1; padding:0 12px 100px; }
    .card{ margin-top:12px; background:#fff; border:1px solid var(--line); border-radius:16px; box-shadow:0 4px 14px rgba(0,0,0,.06); overflow:hidden; }
    .now{ display:grid; grid-template-columns:56px 1fr; gap:12px; align-items:center; padding:14px; }
    .badge{ height:56px; width:56px; border-radius:14px; background:var(--pink-100); color:#be185d; font-weight:800; display:grid; place-items:center; }
    .controls{ margin-top:8px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .btn{ border:1px solid var(--line); background:#fff; border-radius:16px; padding:8px 12px; font-size:14px; }
    .btn-round{ height:48px; width:48px; border-radius:999px; display:grid; place-items:center; box-shadow:0 2px 8px rgba(0,0,0,.08); }
    .btn-primary{ background:var(--pink); color:#fff; border-color:var(--pink); }
    .playlist{ margin-top:12px; }
    .row{ display:flex; gap:12px; align-items:center; width:100%; background:#fff; border:1px solid var(--line); border-radius:16px; padding:12px; margin-bottom:8px; }
    .row.active{ border-color:#be185d; background:#fff0f7; }
    .row .rank{ height:40px; width:40px; border-radius:10px; background:var(--pink-100); color:#be185d; font-weight:800; display:grid; place-items:center; font-size:13px; }
    .row .meta{ flex:1; min-width:0; }
    .row .artist{ font-size:14px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .row .title{ font-size:12px; color:#64748b; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    footer{ position:fixed; left:0; right:0; bottom:0; background:#fff; border-top:1px solid var(--line); padding:6px 12px; font-size:11px; color:#64748b; display:flex; justify-content:space-between; }
    .hint{ margin-top:8px; font-size:12px; color:#64748b; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">뮤직비디오 채널</div>
      <div style="font-size:12px;color:#64748b">JSON 재생 리스트</div>
    </header>

    <main>
      <div class="card">
        <div id="player" style="aspect-ratio:16/9;background:#000"></div>
      </div>

      <div class="card now">
        <div class="badge" id="badge">-</div>
        <div>
          <div style="font-size:12px;color:#64748b">NOW PLAYING</div>
          <div id="now" style="font-size:16px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis"></div>
        </div>
      </div>

      <div class="controls">
        <button id="loopBtn" class="btn">반복</button>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="prevBtn" class="btn btn-round">⏮️</button>
          <button id="playBtn" class="btn btn-round btn-primary">▶️</button>
          <button id="nextBtn" class="btn btn-round">⏭️</button>
        </div>
        <button id="muteBtn" class="btn">🔇</button>
      </div>

      <div class="playlist" id="list"></div>
      <div class="hint" id="hint"></div>
    </main>

    <footer>
      <span>© </span>
      <span>플레이리스트 자동재생 · 모바일 최적화</span>
    </footer>
  </div>

  <script>
    // === 설정 ===
    const FALLBACK = [
      { rank: 1, artist: "BABYMONSTER", title: "DRIP", url: "https://www.youtube.com/watch?v=Zp-Jhuhq0bQ" },
      { rank: 2, artist: "aespa", title: "Whiplash", url: "https://www.youtube.com/watch?v=jWQx2f-CErU" },
      { rank: 3, artist: "Stray Kids", title: "Chk Chk Boom", url: "https://www.youtube.com/watch?v=0P0aQreFs8w" },
      { rank: 4, artist: "LE SSERAFIM", title: "EASY", url: "https://www.youtube.com/watch?v=bNKXxwOQYB8" },
      { rank: 5, artist: "NewJeans", title: "How Sweet", url: "https://www.youtube.com/watch?v=Q3K0TOvTOno" },
      { rank: 6, artist: "임영웅", title: "순간을 영원처럼", url: "https://www.youtube.com/watch?v=sFK89gemgKM" },
      { rank: 7, artist: "IVE", title: "Off the Record", url: "https://www.youtube.com/watch?v=_ApV7Lm87cg" },
      { rank: 8, artist: "SEVENTEEN", title: "MAESTRO", url: "https://www.youtube.com/watch?v=ThI0pBAbFnk" },
      { rank: 9, artist: "NCT 127", title: "Fact Check (불가사의)", url: "https://www.youtube.com/watch?v=vGuJuW0bDWA" },
      { rank: 10, artist: "(여자)아이들", title: "Fate (나는 아픈 건 딱 질색이니까)", url: "https://www.youtube.com/watch?v=ATK7gAaZTOM" }
    ];

    let playlist = [];
    let current = 0;
    let loop = false;
    let isMuted = true; // 모바일 자동재생을 위해 기본 음소거
    let player; // YT.Player

    const $badge = document.getElementById('badge');
    const $now = document.getElementById('now');
    const $list = document.getElementById('list');
    const $play = document.getElementById('playBtn');
    const $prev = document.getElementById('prevBtn');
    const $next = document.getElementById('nextBtn');
    const $mute = document.getElementById('muteBtn');
    const $loop = document.getElementById('loopBtn');
    const $hint = document.getElementById('hint');

    // 유튜브 영상 ID 추출
    function vid(url){
      try{ const u = new URL(url); if(u.hostname.includes('youtu.be')) return u.pathname.slice(1); return u.searchParams.get('v'); }catch(e){ return null; }
    }

    // 플레이어 초기화 (videoId가 바뀔 때마다 호출)
    function mount(videoId){
      if(!window.YT || !window.YT.Player) return;
      if(player){ try{ player.destroy(); }catch(e){} player = null; }
      player = new YT.Player('player',{
        height:'220', width:'100%', videoId,
        playerVars:{ autoplay:1, controls:1, modestbranding:1, rel:0, iv_load_policy:3, playsinline:1, mute:isMuted?1:0 },
        events:{
          onReady:e=>{ if(isMuted) e.target.mute(); e.target.playVideo(); $play.textContent='⏸'; },
          onStateChange:e=>{ if(e.data===0) next(); }, // 종료시 다음 곡
          onError:()=>{ $hint.textContent='YouTube 재생 오류가 발생했어요.'; }
        }
      });
      updateNow();
      renderList();
    }

    function updateNow(){
      const item = playlist[current];
      if(!item) return;
      $badge.textContent = item.rank ?? '-';
      $now.textContent = `${item.artist} — ${item.title}`;
    }

    function renderList(){
      $list.innerHTML = '';
      playlist.forEach((item, idx)=>{
        const row = document.createElement('button');
        row.className = 'row' + (idx===current ? ' active' : '');
        row.innerHTML = `
          <div class="rank">${item.rank}</div>
          <div class="meta">
            <div class="artist">${item.artist}</div>
            <div class="title">${item.title}</div>
          </div>
          <div style="font-size:12px;color:${idx===current?'#be185d':'#94a3b8'}">${idx===current?'● LIVE':'재생'}</div>
        `;
        row.addEventListener('click',()=> select(idx));
        $list.appendChild(row);
      });
    }

    function prev(){ current = (current>0) ? current-1 : (loop ? playlist.length-1 : 0); select(current,true); }
    function next(){ current = (current < playlist.length-1) ? current+1 : (loop ? 0 : playlist.length-1); select(current,true); }

    function select(idx, autoplay){
      current = idx;
      const id = vid(playlist[current].url);
      if(id){ mount(id); if(!autoplay && player){ player.pauseVideo?.(); $play.textContent='▶️'; } }
    }

    // 컨트롤 바인딩
    $prev.addEventListener('click', prev);
    $next.addEventListener('click', next);

    $play.addEventListener('click', ()=>{
      if(!player) return;
      const state = player.getPlayerState?.();
      if(state===1){ player.pauseVideo(); $play.textContent='▶️'; }
      else { player.playVideo(); $play.textContent='⏸'; }
    });

    $mute.addEventListener('click', ()=>{
      if(!player) return;
      if(isMuted){ player.unMute(); isMuted=false; $mute.textContent='🔊'; }
      else { player.mute(); isMuted=true; $mute.textContent='🔇'; }
    });

    $loop.addEventListener('click', ()=>{
      loop = !loop; $loop.style.background = loop ? 'var(--pink)' : '#fff';
      $loop.style.color = loop ? '#fff' : 'inherit';
      $loop.style.borderColor = loop ? 'var(--pink)' : 'var(--line)';
    });

    // JSON 로드 (+ 실패시 fallback)
    async function load(){
      try{
        const res = await fetch('videos.json', {cache:'no-store'});
        if(!res.ok) throw new Error('missing');
        playlist = await res.json();
        $hint.textContent = '';
      }catch(e){
        playlist = FALLBACK;
        $hint.textContent = '⚠️ /videos.json 을 찾지 못해 기본 리스트로 재생합니다.';
      }
      select(0,true);
    }

    // YouTube Iframe API 스크립트 로드
    function loadYT(){
      return new Promise(resolve=>{
        if(window.YT && window.YT.Player) return resolve();
        const s = document.createElement('script'); s.src='https://www.youtube.com/iframe_api';
        window.onYouTubeIframeAPIReady = ()=> resolve();
        document.body.appendChild(s);
      });
    }

    (async function init(){
      await loadYT();
      await load();
    })();
  </script>
</body>
</html>
